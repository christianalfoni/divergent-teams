rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for users within an organization
    match /organizations/{organizationId}/users/{userId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Allow read if user is org member
      allow read: if isOrgMember();
    }

    // Rules for mentions within an organization
    match /organizations/{organizationId}/mentions/{mentionId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Allow read if user is org member
      allow read: if isOrgMember();
    }

    // Rules for teams within an organization
    match /organizations/{organizationId}/teams/{teamId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Helper function to check if user is the creator (for existing docs)
      function isCreator() {
        return resource.data.createdBy == request.auth.uid;
      }

      // Helper function to check if user is creating with themselves as creator
      function isCreatingAsCreator() {
        return request.resource.data.createdBy == request.auth.uid;
      }

      // Allow read if user is org member
      allow read: if isOrgMember();

      // Allow create if user is org member and setting themselves as creator
      allow create: if isOrgMember() && isCreatingAsCreator();

      // Allow delete if user is org member and is the creator
      allow delete: if isOrgMember() && isCreator();
    }

    // Rules for todos within an organization
    match /organizations/{organizationId}/todos/{todoId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Helper function to check if user owns the todo (for existing docs)
      function isOwner() {
        return resource.data.userId == request.auth.uid;
      }

      // Helper function to check if user is creating their own todo
      function isCreatingOwnTodo() {
        return request.resource.data.userId == request.auth.uid;
      }

      // Allow read if user is org member (transparency - anyone can read)
      allow read: if isOrgMember();

      // Allow create if user is org member and creating their own todo
      allow create: if isOrgMember() && isCreatingOwnTodo();

      // Allow update/delete if user is org member and owns the todo
      allow update, delete: if isOrgMember() && isOwner();
    }

    // Rules for tasks within an organization
    match /organizations/{organizationId}/tasks/{taskId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Helper function to check if user is creating with themselves as creator
      function isCreatingAsCreator() {
        return request.resource.data.createdBy == request.auth.uid;
      }

      // Allow read/write if user is org member
      allow read, update, delete: if isOrgMember();

      // Allow create if user is org member and setting themselves as creator
      allow create: if isOrgMember() && isCreatingAsCreator();
    }

    // Rules for conversations within an organization
    match /organizations/{organizationId}/conversations/{conversationId} {

      // Helper function to check if user belongs to the organization
      function isOrgMember() {
        return request.auth != null
          && request.auth.token.organizationId == organizationId;
      }

      // Helper function to check if user is a participant (for existing docs)
      function isParticipant() {
        return request.auth.uid in resource.data.participantUserIds;
      }

      // Helper function to check if user is a participant (for new/updated docs)
      function isParticipantInRequest() {
        return request.auth.uid in request.resource.data.participantUserIds;
      }

      // Allow read if user is org member and is a participant
      allow read: if isOrgMember() && isParticipant();

      // Allow create if user is org member and is included as a participant
      allow create: if isOrgMember() && isParticipantInRequest();

      // Allow update/delete if user is org member and is a participant
      allow update, delete: if isOrgMember() && isParticipant();

      // Rules for messages within a conversation
      match /messages/{messageId} {

        // Helper function to check if user belongs to the organization
        function isOrgMember() {
          return request.auth != null
            && request.auth.token.organizationId == organizationId;
        }

        // Helper function to check if user is a participant in the parent conversation
        function isConversationParticipant() {
          return request.auth.uid in get(/databases/$(database)/documents/organizations/$(organizationId)/conversations/$(conversationId)).data.participantUserIds;
        }

        // Helper function to check if user is creating their own message
        function isCreatingOwnMessage() {
          return request.resource.data.userId == request.auth.uid;
        }

        // Allow read if user is org member and is a participant in the conversation
        allow read: if isOrgMember() && isConversationParticipant();

        // Allow create if user is org member, is a participant, and is creating their own message
        allow create: if isOrgMember() && isConversationParticipant() && isCreatingOwnMessage();

        // Messages are immutable - no updates or deletes allowed
      }
    }
  }
}
